#!/bin/bash
# Pre-commit hook for Meme My Mood
# This hook runs code quality checks before allowing a commit

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_info() {
    echo "â„¹ï¸  $1"
}

# Check if we're in the project root
if [ ! -f "gradlew" ]; then
    print_error "Not in project root directory"
    exit 1
fi

# Get list of staged Kotlin files
STAGED_KT_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.kt$" || true)

if [ -z "$STAGED_KT_FILES" ]; then
    print_info "No Kotlin files staged, skipping checks"
    exit 0
fi

print_info "Found $(echo "$STAGED_KT_FILES" | wc -l) staged Kotlin file(s)"

# Run ktlint format on staged files
print_info "Running ktlint format..."
if ./gradlew ktlintFormat --quiet; then
    print_success "ktlint formatting passed"
    
    # Add formatted files back to staging
    for file in $STAGED_KT_FILES; do
        if [ -f "$file" ]; then
            git add "$file"
        fi
    done
else
    print_error "ktlint formatting failed"
    print_info "Run './gradlew ktlintFormat' to fix formatting issues"
    exit 1
fi

# Run detekt on changed files (quick check)
print_info "Running detekt static analysis..."
if ./gradlew detekt --quiet; then
    print_success "detekt static analysis passed"
else
    print_error "detekt found issues"
    print_info "Run './gradlew detekt' to see detailed report"
    print_warning "You can skip this check with 'git commit --no-verify' (not recommended)"
    exit 1
fi

# Check for common issues
print_info "Checking for common issues..."

# Check for debug statements
DEBUG_STATEMENTS=$(echo "$STAGED_KT_FILES" | xargs grep -n "println\|Log.d\|Log.v" || true)
if [ ! -z "$DEBUG_STATEMENTS" ]; then
    print_warning "Found debug statements in staged files:"
    echo "$DEBUG_STATEMENTS"
    print_info "Consider removing debug statements before committing"
fi

# Check for TODO/FIXME comments
TODO_COMMENTS=$(echo "$STAGED_KT_FILES" | xargs grep -n "TODO\|FIXME" || true)
if [ ! -z "$TODO_COMMENTS" ]; then
    print_warning "Found TODO/FIXME comments:"
    echo "$TODO_COMMENTS"
fi

# Check for large files (>500KB)
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -c%s "{}") -gt 512000 ]; then echo "{}"; fi' || true)
if [ ! -z "$LARGE_FILES" ]; then
    print_warning "Found large files (>500KB):"
    echo "$LARGE_FILES"
    print_info "Consider if these files should be committed"
fi

print_success "All pre-commit checks passed!"
echo ""
exit 0
