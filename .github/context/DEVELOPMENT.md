# Development Guide

## Prerequisites

| Requirement | Version | Notes |
| ----------- | ------- | ----- |
| Android Studio | Ladybug (2024.2.1)+ | Required for Compose previews |
| JDK | 17 | Set in `gradle.properties` |
| Android SDK | 35 | Target and compile SDK |
| Kotlin | 2.3.0 | Managed via version catalog |
| Gradle | 8.x | Via wrapper |

For CLI tool:

| Requirement         | Version | Notes                 |
| ------------------- | ------- | --------------------- |
| Python              | 3.11+   | For meme-my-mood-cli  |
| GitHub Copilot CLI  | Latest  | Authentication for AI |

## Setup

### Android App

```bash
# Clone repository
git clone https://github.com/yourusername/meme-my-mood.git
cd meme-my-mood

# Open in Android Studio and sync Gradle
# Or build from command line:
./gradlew build

# Create local.properties (auto-generated by Android Studio)
# Or manually:
echo "sdk.dir=/path/to/android/sdk" > local.properties
```

### CLI Tool

```powershell
# Windows
cd tools/meme-my-mood-cli
.\scripts\setup.ps1

# Linux/macOS
cd tools/meme-my-mood-cli
./scripts/setup.sh

# Authenticate with Copilot
copilot auth login
```

## Environment Variables

| Variable       | Purpose              | Required | Default |
| -------------- | -------------------- | -------- | ------- |
| `ANDROID_HOME` | Android SDK location | Yes      | -       |
| `JAVA_HOME`    | JDK 17 location      | Yes      | -       |

For CI/CD:

| Variable             | Purpose                     | Required           |
| -------------------- | --------------------------- | ------------------ |
| `KEYSTORE_FILE`      | Release signing keystore    | For release builds |
| `KEYSTORE_PASSWORD`  | Keystore password           | For release builds |
| `KEY_ALIAS`          | Key alias                   | For release builds |
| `KEY_PASSWORD`       | Key password                | For release builds |

## Development Workflow

### Running Locally

```bash
# Build and install debug APK
./gradlew :app:installDebug

# Or run directly from Android Studio
# Click ‚ñ∂ button with device/emulator selected
```

### Running Tests

```bash
# All unit tests
./gradlew test

# Specific module
./gradlew :feature:gallery:test

# Single test class
./gradlew :feature:gallery:testDebugUnitTest --tests "*.GalleryViewModelTest"

# With coverage
./gradlew :feature:gallery:testDebugUnitTestCoverage

# Instrumented tests (requires device/emulator)
./gradlew connectedAndroidTest

# Specific instrumented test
./gradlew :feature:gallery:connectedDebugAndroidTest
```

### Linting

```bash
# Run lint
./gradlew lint

# Check for issues without failing
./gradlew lintDebug

# View report at:
# app/build/reports/lint-results-debug.html
```

### Debugging

**Android Studio**:

1. Set breakpoints in Kotlin code
2. Click Debug (üêû) instead of Run
3. Use Logcat for runtime logs

**Compose UI**:

1. Use Layout Inspector (View ‚Üí Tool Windows ‚Üí Layout Inspector)
2. Add `@Preview` functions for component isolation
3. Use `Modifier.border()` to debug layout issues

**Database**:

1. Use App Inspection (View ‚Üí Tool Windows ‚Üí App Inspection)
2. Select Database Inspector tab
3. Query and browse Room tables

## Build & Deploy

### Debug Build

```bash
./gradlew :app:assembleDebug
# Output: app/build/outputs/apk/debug/app-debug.apk
```

### Release Build

```bash
# Create release keystore (one-time)
keytool -genkey -v -keystore release.keystore -alias release -keyalg RSA -keysize 2048 -validity 10000

# Build signed release
./gradlew :app:assembleRelease
# Output: app/build/outputs/apk/release/app-release.apk

# Build bundle for Play Store
./gradlew :app:bundleRelease
# Output: app/build/outputs/bundle/release/app-release.aab
```

### Baseline Profile Generation

```bash
# Connect device/emulator with API 28+
# Run baseline profile generator
./gradlew :app:generateBaselineProfile

# This runs :baselineprofile module tests that exercise
# critical user journeys and generates optimized profiles
```

## Common Tasks

### Adding a New Feature Module

1. Create module directory structure:

   ```text
   feature/
     newfeature/
    build.gradle.kts
    src/
      main/
        kotlin/com/mememymood/feature/newfeature/
          di/
            NewFeatureModule.kt
          domain/
            repository/
            usecase/
          data/
          presentation/
            NewFeatureScreen.kt
            NewFeatureViewModel.kt
            NewFeatureUiState.kt
            NewFeatureIntent.kt
            NewFeatureEffect.kt
          navigation/
            NewFeatureNavigation.kt
        res/
          values/
            strings.xml
      test/
        kotlin/com/mememymood/feature/newfeature/
          presentation/
            NewFeatureViewModelTest.kt
   ```

1. Add to `settings.gradle.kts`:

   ```kotlin
   include(":feature:newfeature")
   ```

1. Create `build.gradle.kts`:

   ```kotlin
   plugins {
    alias(libs.plugins.android.library)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.ksp)
    alias(libs.plugins.hilt)
    alias(libs.plugins.kotlin.serialization)
    alias(libs.plugins.compose.compiler)
}

android {
    namespace = "com.mememymood.feature.newfeature"
    // ... standard config
}

dependencies {
    implementation(project(":core:common"))
    implementation(project(":core:model"))
    implementation(project(":core:ui"))
    implementation(project(":core:database"))
    // ... standard dependencies
}
   ```

1. Add navigation in app module's `MemeMoodNavHost.kt`

### Adding a New Dependency

1. Add version to `gradle/libs.versions.toml`:

   ```toml
   [versions]
   newlib = "1.0.0"

   [libraries]
   newlib-core = { group = "com.example", name = "newlib", version.ref = "newlib" }
   ```

1. Use in module's `build.gradle.kts`:

   ```kotlin
   dependencies {
    implementation(libs.newlib.core)
}
   ```

### Adding a Database Migration

1. Increment version in `MemeDatabase.kt`:

   ```kotlin
   @Database(
       entities = [...],
       version = 4,  // Increment
       exportSchema = true
   )
   ```

1. Add migration object:

   ```kotlin
   companion object {
       val MIGRATION_3_4 = object : Migration(3, 4) {
           override fun migrate(db: SupportSQLiteDatabase) {
               db.execSQL("ALTER TABLE memes ADD COLUMN newColumn TEXT")
           }
       }
   }
   ```

1. Register in `DatabaseModule.kt`:

   ```kotlin
   .addMigrations(
       MemeDatabase.MIGRATION_1_2,
       MemeDatabase.MIGRATION_2_3,
       MemeDatabase.MIGRATION_3_4,  // Add new migration
   )
   ```

1. Export schema for testing:

   ```bash
   ./gradlew :core:database:kspDebugKotlin
   # Schema JSON appears in core/database/schemas/
   ```

### Running the CLI Tool

```bash
# Activate virtual environment
cd tools/meme-my-mood-cli
.\.venv\Scripts\Activate.ps1  # Windows
# source .venv/bin/activate  # Linux/macOS

# Check authentication
meme-cli check

# Annotate images in a folder
meme-cli annotate /path/to/images

# Continue a previous run (skip existing sidecars)
meme-cli annotate /path/to/images --continue

# Force regenerate all sidecars
meme-cli annotate /path/to/images --force

# Preview what would be processed
meme-cli annotate /path/to/images --dry-run

# Create ZIP bundle for import
meme-cli annotate /path/to/images --zip

# Multilingual output (English + Czech + German)
meme-cli annotate /path/to/images --languages en,cs,de

# Verbose output
meme-cli annotate /path/to/images -v
```

## Troubleshooting

| Issue | Solution |
| --- | --- |
| Gradle sync fails | Check `local.properties` has correct SDK path |
| Compose preview broken | Rebuild project, check Compose BOM version |
| Hilt errors | Run `./gradlew clean` then rebuild |
| Room schema mismatch | Check migration version, export new schema |
| Tests fail with dispatcher | Use `MainDispatcherRule` in tests |
| CLI rate limited | Wait 1-2 minutes, tool handles backoff automatically |
| CLI auth error | Run `copilot auth login` |
| Embedding generation slow | Uses WorkManager, check App Inspection |

## Useful Commands

```bash
# Clean build
./gradlew clean

# Rebuild entire project
./gradlew build

# Show dependency tree
./gradlew :app:dependencies

# Check for dependency updates
./gradlew dependencyUpdates

# Generate KSP sources (Room, Hilt)
./gradlew kspDebugKotlin

# Run specific Gradle task with stacktrace
./gradlew :app:assembleDebug --stacktrace

# Profile build
./gradlew :app:assembleDebug --profile

# List all tasks
./gradlew tasks
```

## Project-Specific Notes

- **Kotlin source path**: Always use `src/main/kotlin/`, not `src/main/java/`
- **FTS sync**: When updating `MemeEntity`, ensure `MemeFtsEntity` triggers are maintained
- **Type-safe navigation**: Use `@Serializable` route objects from `core:common`
- **Embedding model**: If changing model, update `EmbeddingModelVersionManager` to trigger re-generation
- **WorkManager tests**: Use `WorkManagerTestInitHelper` from `:core:testing`
